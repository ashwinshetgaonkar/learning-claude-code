import httpx
from typing import Optional
from io import BytesIO

try:
    from weasyprint import HTML, CSS
    WEASYPRINT_AVAILABLE = True
except ImportError:
    WEASYPRINT_AVAILABLE = False


class PDFGenerator:
    def __init__(self):
        self.client = httpx.AsyncClient(timeout=60.0)

    async def generate_from_article(
        self,
        title: str,
        authors: list,
        abstract: str,
        content: Optional[str],
        url: str,
        summary: Optional[str] = None
    ) -> Optional[bytes]:
        """Generate PDF from article content."""
        if not WEASYPRINT_AVAILABLE:
            return None

        html_content = self._create_html(title, authors, abstract, content, url, summary)

        try:
            html = HTML(string=html_content)
            css = CSS(string=self._get_css())
            pdf_bytes = html.write_pdf(stylesheets=[css])
            return pdf_bytes
        except Exception as e:
            print(f"Error generating PDF: {e}")
            return None

    async def download_pdf(self, pdf_url: str) -> Optional[bytes]:
        """Download PDF from URL (for arXiv papers)."""
        try:
            response = await self.client.get(pdf_url, follow_redirects=True)
            response.raise_for_status()

            if "application/pdf" in response.headers.get("content-type", ""):
                return response.content
            return None
        except Exception as e:
            print(f"Error downloading PDF: {e}")
            return None

    def _create_html(
        self,
        title: str,
        authors: list,
        abstract: str,
        content: Optional[str],
        url: str,
        summary: Optional[str]
    ) -> str:
        """Create HTML content for PDF generation."""
        authors_str = ", ".join(authors) if authors else "Unknown"

        html = f"""
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{title}</title>
</head>
<body>
    <header>
        <h1>{title}</h1>
        <p class="authors">{authors_str}</p>
        <p class="url">Source: <a href="{url}">{url}</a></p>
    </header>

    <main>
"""
        if summary:
            html += f"""
        <section class="summary">
            <h2>AI Summary</h2>
            <p>{summary}</p>
        </section>
"""

        if abstract:
            html += f"""
        <section class="abstract">
            <h2>Abstract</h2>
            <p>{abstract}</p>
        </section>
"""

        if content:
            html += f"""
        <section class="content">
            <h2>Content</h2>
            <div>{content}</div>
        </section>
"""

        html += """
    </main>

    <footer>
        <p>Generated by AI News Tracker</p>
    </footer>
</body>
</html>
"""
        return html

    def _get_css(self) -> str:
        """Return CSS styles for PDF."""
        return """
@page {
    margin: 2cm;
    @bottom-center {
        content: counter(page);
    }
}

body {
    font-family: 'Helvetica', 'Arial', sans-serif;
    font-size: 11pt;
    line-height: 1.6;
    color: #333;
}

header {
    margin-bottom: 2em;
    border-bottom: 2px solid #333;
    padding-bottom: 1em;
}

h1 {
    font-size: 18pt;
    margin-bottom: 0.5em;
    color: #1a1a1a;
}

.authors {
    font-style: italic;
    color: #666;
}

.url {
    font-size: 9pt;
    color: #888;
}

h2 {
    font-size: 14pt;
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    color: #2a2a2a;
}

.summary {
    background-color: #f5f5f5;
    padding: 1em;
    border-radius: 5px;
    margin-bottom: 1em;
}

.abstract {
    margin-bottom: 1em;
}

.content {
    text-align: justify;
}

footer {
    margin-top: 2em;
    padding-top: 1em;
    border-top: 1px solid #ccc;
    font-size: 9pt;
    color: #888;
    text-align: center;
}

a {
    color: #0066cc;
    text-decoration: none;
}
"""

    async def close(self):
        await self.client.aclose()


# Singleton instance
pdf_generator = PDFGenerator()
